<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPTV Player - M3U/M3U8 Playlist</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #0f0f1a 100%);
        }
        .channel-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
        }
        .channel-active {
            border-color: #6366f1 !important;
            background: rgba(99, 102, 241, 0.2) !important;
        }
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }
        .scrollbar-thin::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: rgba(99, 102, 241, 0.5);
            border-radius: 3px;
        }
        .glow {
            box-shadow: 0 0 30px rgba(99, 102, 241, 0.2);
        }
        /* Channel Carousel */
        .carousel-container {
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease-in-out;
            pointer-events: none;
        }
        .carousel-container.visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }
        .carousel-track {
            scroll-behavior: smooth;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .carousel-track::-webkit-scrollbar {
            display: none;
        }
        .carousel-item {
            transition: all 0.2s ease;
        }
        .carousel-item:hover {
            transform: scale(1.05);
            border-color: #6366f1;
        }
        .carousel-item.active {
            border-color: #6366f1;
            background: rgba(99, 102, 241, 0.3);
        }
        .carousel-arrow {
            transition: all 0.2s ease;
        }
        .carousel-arrow:hover {
            background: rgba(99, 102, 241, 0.8);
            transform: scale(1.1);
        }
        /* Fullscreen styles */
        #videoWrapper:fullscreen,
        #videoWrapper:-webkit-full-screen {
            width: 100%;
            height: 100%;
            background: black;
            display: flex;
            flex-direction: column;
        }
        #videoWrapper:fullscreen video,
        #videoWrapper:-webkit-full-screen video {
            flex: 1;
            height: 100%;
            max-height: 100%;
        }
        #videoWrapper:fullscreen .carousel-container,
        #videoWrapper:-webkit-full-screen .carousel-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
        }
        #videoWrapper:fullscreen #hoverZone,
        #videoWrapper:-webkit-full-screen #hoverZone {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 150px;
        }
        /* Dark theme for select dropdown */
        select {
            background-color: #1a1a2e;
            color: white;
        }
        select option {
            background-color: #1a1a2e;
            color: white;
            padding: 10px;
        }
        select option:hover,
        select option:focus,
        select option:checked {
            background: linear-gradient(#4f46e5, #4f46e5);
            color: white;
        }
        
        /* Mobile expandable channel list */
        @media (max-width: 1023px) {
            .channel-sidebar {
                transition: max-height 0.3s ease-in-out;
                max-height: 60px;
                overflow: hidden;
            }
            .channel-sidebar.expanded {
                max-height: 70vh;
            }
            .channel-sidebar.expanded .channel-content {
                opacity: 1;
                pointer-events: all;
            }
            .channel-content {
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.2s ease-in-out;
            }
            .channel-sidebar.expanded .channel-content {
                opacity: 1;
            }
        }
        @media (min-width: 1024px) {
            .channel-sidebar {
                max-height: none !important;
            }
            .channel-content {
                opacity: 1 !important;
                pointer-events: all !important;
            }
            .expand-toggle {
                display: none !important;
            }
        }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white">
    <div class="flex flex-col h-screen">
        <!-- Header -->
        <header class="bg-black/30 backdrop-blur-lg border-b border-white/10 px-4 py-3">
            <div class="flex items-center justify-between flex-wrap gap-3">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">IPTV Player</h1>
                        <p class="text-xs text-gray-400">M3U/M3U8 Playlist Player</p>
                    </div>
                </div>
                <button onclick="openPlaylistModal()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg font-medium transition-all flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    Load Playlist
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col-reverse lg:flex-row overflow-hidden">
            <!-- Channel Sidebar -->
            <aside id="channelSidebar" class="channel-sidebar w-full lg:w-80 bg-black/20 border-r border-white/10 flex flex-col overflow-hidden min-h-0 lg:max-h-none">
                <!-- Mobile Expand Toggle -->
                <button onclick="toggleChannelList()" class="expand-toggle w-full p-3 flex items-center justify-between bg-black/30 border-b border-white/10 lg:hidden">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 bg-gray-600 rounded-lg flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                            </svg>
                        </div>
                        <div class="text-left">
                            <p class="font-medium text-sm">Channel List</p>
                            <p class="text-xs text-gray-400"><span id="channelCountMobile">0</span> channels</p>
                        </div>
                    </div>
                    <svg id="expandIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>
                
                <!-- Channel Content (collapsible on mobile) -->
                <div class="channel-content flex flex-col flex-1 overflow-hidden">
                    <!-- Search & Filter -->
                    <div class="p-3 border-b border-white/10 space-y-2">
                        <div class="relative">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                            <input type="text" id="searchInput" placeholder="Search channels..." oninput="filterChannels()" class="w-full pl-10 pr-4 py-2 bg-white/5 border border-white/10 rounded-lg focus:border-indigo-500 focus:outline-none text-sm">
                        </div>
                        <select id="groupFilter" onchange="filterChannels()" class="w-full px-3 py-2 bg-white/5 border border-white/10 rounded-lg focus:border-indigo-500 focus:outline-none text-sm">
                            <option value="">All Categories</option>
                        </select>
                    </div>

                    <!-- Channel Count -->
                    <div class="px-3 py-2 text-xs text-gray-400 border-b border-white/10 hidden lg:block">
                        <span id="channelCount">0</span> channels
                    </div>

                    <!-- Channel List -->
                    <div id="channelList" class="flex-1 overflow-y-auto scrollbar-thin p-2 space-y-1">
                    <div class="text-center py-12 text-gray-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                        <p>No channels loaded</p>
                        <p class="text-sm mt-1">Click "Load Playlist" to add channels</p>
                    </div>
                </div>
                </div>
            </aside>

            <!-- Video Player Area -->
            <main class="flex-1 flex flex-col bg-black/40 overflow-hidden">
                <!-- Now Playing Info -->
                <div id="nowPlaying" class="px-4 py-3 bg-black/30 border-b border-white/10 hidden">
                    <div class="flex items-center gap-3">
                        <div id="nowPlayingLogo" class="w-10 h-10 bg-indigo-600/30 rounded-lg flex items-center justify-center overflow-hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                            </svg>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h2 id="nowPlayingTitle" class="font-semibold truncate">No channel selected</h2>
                            <p id="nowPlayingGroup" class="text-xs text-gray-400 truncate"></p>
                        </div>
                        <div id="statusIndicator" class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-gray-500" id="statusDot"></span>
                            <span class="text-xs text-gray-400" id="statusText">Ready</span>
                        </div>
                    </div>
                </div>

                <!-- Video Container -->
                <div class="flex-1 flex items-center justify-center p-4">
                    <div class="w-full max-w-5xl">
                        <div class="bg-black rounded-2xl overflow-hidden glow relative group" id="videoWrapper">
                            <!-- Channel Carousel Overlay -->
                            <div id="channelCarousel" class="carousel-container absolute top-0 left-0 right-0 z-20 bg-gradient-to-b from-black/90 via-black/70 to-transparent p-4 pb-8">
                                <div class="flex items-center gap-2">
                                    <!-- Left Arrow -->
                                    <button onclick="scrollCarousel(-1)" class="carousel-arrow flex-shrink-0 w-10 h-10 bg-white/10 hover:bg-indigo-600 rounded-full flex items-center justify-center backdrop-blur-sm border border-white/20">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                                        </svg>
                                    </button>
                                    
                                    <!-- Carousel Track -->
                                    <div id="carouselTrack" class="carousel-track flex-1 flex gap-3 overflow-x-auto py-2">
                                        <div class="text-center text-gray-500 text-sm w-full py-4">Load a playlist to see channels</div>
                                    </div>
                                    
                                    <!-- Right Arrow -->
                                    <button onclick="scrollCarousel(1)" class="carousel-arrow flex-shrink-0 w-10 h-10 bg-white/10 hover:bg-indigo-600 rounded-full flex items-center justify-center backdrop-blur-sm border border-white/20">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Hover Detection Zone -->
                            <div id="hoverZone" class="absolute top-0 left-0 right-0 h-1/3 z-10"></div>
                            
                            <!-- Fullscreen Button -->
                            <button onclick="toggleFullscreen()" class="absolute bottom-4 right-4 z-20 w-10 h-10 bg-black/50 hover:bg-indigo-600 rounded-full flex items-center justify-center backdrop-blur-sm border border-white/20 transition-all opacity-0 hover:opacity-100 group-hover:opacity-100" id="fullscreenBtn">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                                </svg>
                            </button>
                            
                            <video 
                                id="videoPlayer" 
                                controls 
                                autoplay
                                playsinline
                                class="w-full aspect-video bg-black"
                                poster="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1920 1080'%3E%3Crect fill='%23111' width='1920' height='1080'/%3E%3Ctext x='50%25' y='45%25' fill='%23333' font-size='64' text-anchor='middle' font-family='system-ui'%3EðŸ“º%3C/text%3E%3Ctext x='50%25' y='55%25' fill='%23444' font-size='32' text-anchor='middle' font-family='system-ui'%3ESelect a channel to watch%3C/text%3E%3C/svg%3E"
                            ></video>
                        </div>
                        <!-- Error Message -->
                        <div id="errorMsg" class="hidden mt-4 p-4 bg-red-500/20 border border-red-500/50 rounded-xl text-red-300 text-sm">
                            <p id="errorText"></p>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Playlist Modal -->
    <div id="playlistModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-gray-900 rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden border border-white/10">
            <div class="flex items-center justify-between p-4 border-b border-white/10">
                <h2 class="text-xl font-bold">Load M3U/M3U8 Playlist</h2>
                <button onclick="closePlaylistModal()" class="p-2 hover:bg-white/10 rounded-lg transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <div class="p-4 space-y-4 overflow-y-auto max-h-[calc(90vh-140px)]">
                <!-- Tabs -->
                <div class="flex gap-2 border-b border-white/10 pb-3 flex-wrap">
                    <button onclick="switchTab('stream')" id="tabStream" class="px-4 py-2 rounded-lg bg-indigo-600 text-white font-medium transition-all">Stream URL</button>
                    <button onclick="switchTab('url')" id="tabUrl" class="px-4 py-2 rounded-lg bg-white/5 hover:bg-white/10 text-gray-400 font-medium transition-all">Playlist URL</button>
                    <button onclick="switchTab('text')" id="tabText" class="px-4 py-2 rounded-lg bg-white/5 hover:bg-white/10 text-gray-400 font-medium transition-all">Paste Playlist</button>
                </div>

                <!-- Direct Stream URL Input -->
                <div id="streamSection">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Direct M3U8 Stream URL</label>
                    <input type="url" id="streamUrl" placeholder="https://example.com/stream.m3u8" class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl focus:border-indigo-500 focus:outline-none">
                    <p class="text-xs text-gray-500 mt-2">Enter a direct .m3u8 stream URL to play immediately</p>
                </div>

                <!-- URL Input -->
                <div id="urlSection" class="hidden">
                    <label class="block text-sm font-medium text-gray-300 mb-2">M3U Playlist URL</label>
                    <input type="url" id="playlistUrl" placeholder="https://example.com/playlist.m3u" class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl focus:border-indigo-500 focus:outline-none">
                    <p class="text-xs text-gray-500 mt-2">Enter the URL of an M3U playlist file containing multiple channels</p>
                </div>

                <!-- Text Input -->
                <div id="textSection" class="hidden">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Paste M3U Playlist Content</label>
                    <textarea id="playlistText" rows="10" placeholder="#EXTM3U
#EXTINF:-1 group-title=&quot;News&quot;,CNN
http://stream-url.m3u8
#EXTINF:-1 group-title=&quot;Sports&quot;,ESPN
http://another-stream.m3u8" class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl focus:border-indigo-500 focus:outline-none font-mono text-sm resize-none"></textarea>
                </div>

                <!-- Demo Playlists -->
                <div class="pt-2">
                    <p class="text-sm text-gray-400 mb-2">Or try demo streams:</p>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="loadDemoPlaylist()" class="text-xs px-3 py-2 bg-white/5 hover:bg-white/10 rounded-lg border border-white/10 transition-all">
                            ðŸ“º Demo Channels
                        </button>
                    </div>
                </div>
            </div>

            <div class="p-4 border-t border-white/10 flex justify-end gap-3">
                <button onclick="closePlaylistModal()" class="px-4 py-2 bg-white/5 hover:bg-white/10 rounded-lg transition-all">Cancel</button>
                <button onclick="loadPlaylist()" id="loadBtn" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg font-medium transition-all">Play Stream</button>
            </div>
        </div>
    </div>

    <script>
        // State
        let channels = [];
        let filteredChannels = [];
        let currentChannel = null;
        let hls = null;
        let activeTab = 'stream';
        let channelListExpanded = false;

        // DOM Elements
        const video = document.getElementById('videoPlayer');
        const channelList = document.getElementById('channelList');
        const channelCount = document.getElementById('channelCount');
        const searchInput = document.getElementById('searchInput');
        const groupFilter = document.getElementById('groupFilter');
        const nowPlaying = document.getElementById('nowPlaying');
        const nowPlayingTitle = document.getElementById('nowPlayingTitle');
        const nowPlayingGroup = document.getElementById('nowPlayingGroup');
        const nowPlayingLogo = document.getElementById('nowPlayingLogo');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const errorMsg = document.getElementById('errorMsg');
        const errorText = document.getElementById('errorText');

        // Channel List Toggle (Mobile)
        function toggleChannelList() {
            const sidebar = document.getElementById('channelSidebar');
            const expandIcon = document.getElementById('expandIcon');
            channelListExpanded = !channelListExpanded;
            
            if (channelListExpanded) {
                sidebar.classList.add('expanded');
                expandIcon.style.transform = 'rotate(180deg)';
            } else {
                sidebar.classList.remove('expanded');
                expandIcon.style.transform = 'rotate(0deg)';
            }
        }

        function collapseChannelList() {
            const sidebar = document.getElementById('channelSidebar');
            const expandIcon = document.getElementById('expandIcon');
            channelListExpanded = false;
            sidebar.classList.remove('expanded');
            if (expandIcon) {
                expandIcon.style.transform = 'rotate(0deg)';
            }
        }

        // Modal Functions
        function openPlaylistModal() {
            document.getElementById('playlistModal').classList.remove('hidden');
        }

        function closePlaylistModal() {
            document.getElementById('playlistModal').classList.add('hidden');
        }

        function switchTab(tab) {
            activeTab = tab;
            const tabs = ['stream', 'url', 'text'];
            tabs.forEach(t => {
                const tabBtn = document.getElementById('tab' + t.charAt(0).toUpperCase() + t.slice(1));
                const section = document.getElementById(t + 'Section');
                if (tabBtn) {
                    tabBtn.className = tab === t 
                        ? 'px-4 py-2 rounded-lg bg-indigo-600 text-white font-medium transition-all'
                        : 'px-4 py-2 rounded-lg bg-white/5 hover:bg-white/10 text-gray-400 font-medium transition-all';
                }
                if (section) {
                    section.classList.toggle('hidden', tab !== t);
                }
            });
            
            // Update button text
            const loadBtn = document.getElementById('loadBtn');
            if (loadBtn) {
                loadBtn.textContent = tab === 'stream' ? 'Play Stream' : 'Load Playlist';
            }
        }

        // Parse M3U Content
        function parseM3U(content) {
            const lines = content.split('\n');
            const parsedChannels = [];
            let currentInfo = null;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                if (line.startsWith('#EXTINF:')) {
                    // Parse channel info
                    const info = {};
                    
                    // Extract name (after the last comma)
                    const nameMatch = line.match(/,(.+)$/);
                    info.name = nameMatch ? nameMatch[1].trim() : 'Unknown Channel';
                    
                    // Extract tvg-logo
                    const logoMatch = line.match(/tvg-logo="([^"]+)"/);
                    info.logo = logoMatch ? logoMatch[1] : null;
                    
                    // Extract group-title
                    const groupMatch = line.match(/group-title="([^"]+)"/);
                    info.group = groupMatch ? groupMatch[1] : 'Uncategorized';
                    
                    // Extract tvg-id
                    const idMatch = line.match(/tvg-id="([^"]+)"/);
                    info.id = idMatch ? idMatch[1] : null;
                    
                    currentInfo = info;
                } else if (line && !line.startsWith('#') && currentInfo) {
                    // This is the URL
                    parsedChannels.push({
                        ...currentInfo,
                        url: line
                    });
                    currentInfo = null;
                }
            }

            return parsedChannels;
        }

        // Load Playlist
        async function loadPlaylist() {
            let content = '';
            
            // Handle direct stream URL
            if (activeTab === 'stream') {
                const url = document.getElementById('streamUrl').value.trim();
                if (!url) {
                    alert('Please enter a stream URL');
                    return;
                }
                
                // Create a single channel from the stream URL
                const streamName = url.split('/').pop().replace('.m3u8', '') || 'Stream';
                channels = [{
                    name: streamName,
                    url: url,
                    group: 'Direct Stream',
                    logo: null
                }];
                
                // Update groups filter
                groupFilter.innerHTML = '<option value="">All Categories</option><option value="Direct Stream">Direct Stream</option>';
                
                filterChannels();
                renderCarousel();
                closePlaylistModal();
                
                // Auto-play the stream
                playChannel(0);
                return;
            }
            
            if (activeTab === 'url') {
                const url = document.getElementById('playlistUrl').value.trim();
                if (!url) {
                    alert('Please enter a playlist URL');
                    return;
                }
                
                try {
                    // Try direct fetch first
                    const response = await fetch(url);
                    content = await response.text();
                } catch (error) {
                    // Try with CORS proxy
                    try {
                        const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                        const response = await fetch(proxyUrl);
                        content = await response.text();
                    } catch (e) {
                        alert('Failed to fetch playlist. Try pasting the content directly.');
                        return;
                    }
                }
                
                // Check if it's a direct m3u8 stream (not a playlist)
                if (!content.includes('#EXTINF') && (url.endsWith('.m3u8') || content.includes('#EXT-X-'))) {
                    // It's a direct HLS stream, not a playlist
                    const streamName = url.split('/').pop().replace('.m3u8', '') || 'Stream';
                    channels = [{
                        name: streamName,
                        url: url,
                        group: 'Direct Stream',
                        logo: null
                    }];
                    
                    groupFilter.innerHTML = '<option value="">All Categories</option><option value="Direct Stream">Direct Stream</option>';
                    filterChannels();
                    renderCarousel();
                    closePlaylistModal();
                    playChannel(0);
                    return;
                }
            } else {
                content = document.getElementById('playlistText').value.trim();
                if (!content) {
                    alert('Please paste playlist content');
                    return;
                }
            }

            channels = parseM3U(content);
            
            if (channels.length === 0) {
                alert('No channels found in playlist. If you\'re trying to play a direct stream, use the "Stream URL" tab.');
                return;
            }

            // Update groups filter
            const groups = [...new Set(channels.map(c => c.group))].sort();
            groupFilter.innerHTML = '<option value="">All Categories</option>';
            groups.forEach(group => {
                groupFilter.innerHTML += `<option value="${group}">${group}</option>`;
            });

            filterChannels();
            renderCarousel();
            closePlaylistModal();
        }

        // Demo Playlist
        function loadDemoPlaylist() {
            const demoContent = `#EXTM3U
#EXTINF:-1 tvg-logo="https://upload.wikimedia.org/wikipedia/commons/thumb/4/41/Sunflower_from_Silesia.jpg/800px-Sunflower_from_Silesia.jpg" group-title="Demo",Big Buck Bunny
https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8
#EXTINF:-1 tvg-logo="https://upload.wikimedia.org/wikipedia/commons/thumb/1/14/Gatto_europeo4.jpg/250px-Gatto_europeo4.jpg" group-title="Demo",Sintel (Blender)
https://bitdash-a.akamaihd.net/content/sintel/hls/playlist.m3u8
#EXTINF:-1 group-title="Movies",Tears of Steel
https://demo.unified-streaming.com/k8s/features/stable/video/tears-of-steel/tears-of-steel.ism/.m3u8
#EXTINF:-1 group-title="Test",Test Pattern
https://cph-p2p-msl.akamaized.net/hls/live/2000341/test/master.m3u8
#EXTINF:-1 group-title="Movies",Oceans (AES Encrypted)
https://playertest.longtailvideo.com/adaptive/oceans_aes/oceans_aes.m3u8
#EXTINF:-1 group-title="Test",Akamai Test Stream
https://cph-msl.akamaized.net/hls/live/2000341/test/master.m3u8`;
            
            document.getElementById('playlistText').value = demoContent;
            switchTab('text');
            loadPlaylist();
        }

        // Filter Channels
        function filterChannels() {
            const search = searchInput.value.toLowerCase();
            const group = groupFilter.value;

            filteredChannels = channels.filter(channel => {
                const matchesSearch = channel.name.toLowerCase().includes(search);
                const matchesGroup = !group || channel.group === group;
                return matchesSearch && matchesGroup;
            });

            renderChannelList();
        }

        // Render Channel List
        function renderChannelList() {
            channelCount.textContent = filteredChannels.length;
            document.getElementById('channelCountMobile').textContent = filteredChannels.length;

            if (filteredChannels.length === 0) {
                channelList.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                        <p>${channels.length === 0 ? 'No channels loaded' : 'No channels match your search'}</p>
                    </div>
                `;
                return;
            }

            channelList.innerHTML = filteredChannels.map((channel, index) => `
                <button 
                    ondblclick="playChannel(${channels.indexOf(channel)})"
                    class="channel-card w-full flex items-center gap-3 p-3 rounded-xl bg-white/5 border border-white/5 hover:border-indigo-500/50 hover:bg-white/10 transition-all text-left ${currentChannel === channels.indexOf(channel) ? 'channel-active' : ''}"
                >
                    <div class="w-10 h-10 rounded-lg bg-indigo-600/30 flex-shrink-0 flex items-center justify-center overflow-hidden">
                        ${channel.logo 
                            ? `<img src="${channel.logo}" alt="" class="w-full h-full object-cover" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'"><span class="hidden text-lg">ðŸ“º</span>`
                            : '<span class="text-lg">ðŸ“º</span>'
                        }
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="font-medium truncate text-sm">${channel.name}</p>
                        <p class="text-xs text-gray-500 truncate">${channel.group}</p>
                    </div>
                </button>
            `).join('');
        }

        // Play Channel
        function playChannel(index) {
            const channel = channels[index];
            if (!channel) return;

            currentChannel = index;
            hideError();
            updateStatus('loading', 'Loading...');
            
            // Collapse channel list on mobile when playing
            collapseChannelList();
            
            // Update now playing
            nowPlaying.classList.remove('hidden');
            nowPlayingTitle.textContent = channel.name;
            nowPlayingGroup.textContent = channel.group;
            
            if (channel.logo) {
                nowPlayingLogo.innerHTML = `<img src="${channel.logo}" alt="" class="w-full h-full object-cover" onerror="this.outerHTML='<span class=\\'text-xl\\'>ðŸ“º</span>'">`;
            } else {
                nowPlayingLogo.innerHTML = '<span class="text-xl">ðŸ“º</span>';
            }

            // Update channel list UI
            renderChannelList();
            renderCarousel();

            // Load stream
            loadStream(channel.url);
        }

        // Load Stream
        function loadStream(url) {
            // Destroy previous HLS instance
            if (hls) {
                hls.destroy();
                hls = null;
            }

            // Reset video
            video.pause();
            video.removeAttribute('src');
            video.load();

            // Check if HLS is supported
            if (Hls.isSupported()) {
                hls = new Hls({
                    debug: false,
                    enableWorker: true,
                    lowLatencyMode: true,
                });

                hls.loadSource(url);
                hls.attachMedia(video);

                hls.on(Hls.Events.MANIFEST_PARSED, function() {
                    updateStatus('playing', 'Live');
                    // Force play
                    const playPromise = video.play();
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            updateStatus('playing', 'Live');
                        }).catch(e => {
                            console.log('Autoplay prevented:', e);
                            updateStatus('ready', 'Click to play');
                        });
                    }
                });

                hls.on(Hls.Events.ERROR, function(event, data) {
                    if (data.fatal) {
                        switch(data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                showError('Network error - check your connection or stream URL');
                                updateStatus('error', 'Error');
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                hls.recoverMediaError();
                                break;
                            default:
                                showError('Failed to load stream');
                                updateStatus('error', 'Error');
                                hls.destroy();
                                break;
                        }
                    }
                });

            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                // Native HLS support (Safari)
                video.src = url;
                video.addEventListener('loadedmetadata', function onLoaded() {
                    video.removeEventListener('loadedmetadata', onLoaded);
                    updateStatus('playing', 'Live');
                    video.play().catch(() => updateStatus('ready', 'Click to play'));
                });
                video.addEventListener('error', function onError() {
                    video.removeEventListener('error', onError);
                    showError('Error loading stream');
                    updateStatus('error', 'Error');
                });
                video.load();
            } else {
                showError('HLS is not supported in this browser');
                updateStatus('error', 'Not supported');
            }
        }

        // Status Functions
        function updateStatus(status, message) {
            statusText.textContent = message;
            statusDot.className = 'w-2 h-2 rounded-full';
            
            switch(status) {
                case 'playing':
                    statusDot.classList.add('bg-green-500', 'animate-pulse');
                    break;
                case 'loading':
                    statusDot.classList.add('bg-yellow-500', 'animate-pulse');
                    break;
                case 'error':
                    statusDot.classList.add('bg-red-500');
                    break;
                default:
                    statusDot.classList.add('bg-gray-500');
            }
        }

        function showError(message) {
            errorText.textContent = message;
            errorMsg.classList.remove('hidden');
        }

        function hideError() {
            errorMsg.classList.add('hidden');
        }

        // Video Events
        video.addEventListener('play', () => updateStatus('playing', 'Live'));
        video.addEventListener('pause', () => updateStatus('ready', 'Paused'));
        video.addEventListener('waiting', () => updateStatus('loading', 'Buffering...'));
        video.addEventListener('playing', () => updateStatus('playing', 'Live'));

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            if (e.key === 'ArrowUp' && currentChannel > 0) {
                playChannel(currentChannel - 1);
            } else if (e.key === 'ArrowDown' && currentChannel < channels.length - 1) {
                playChannel(currentChannel + 1);
            } else if (e.key === ' ') {
                e.preventDefault();
                video.paused ? video.play() : video.pause();
            } else if (e.key === 'f') {
                toggleFullscreen();
            } else if (e.key === 'ArrowLeft' && currentChannel > 0) {
                playChannel(currentChannel - 1);
            } else if (e.key === 'ArrowRight' && currentChannel < channels.length - 1) {
                playChannel(currentChannel + 1);
            } else if (e.key === 'Escape') {
                exitFullscreen();
            }
        });

        // Fullscreen functions
        function toggleFullscreen() {
            if (document.fullscreenElement || document.webkitFullscreenElement) {
                exitFullscreen();
            } else {
                enterFullscreen();
            }
        }

        function enterFullscreen() {
            const wrapper = document.getElementById('videoWrapper');
            if (wrapper.requestFullscreen) {
                wrapper.requestFullscreen();
            } else if (wrapper.webkitRequestFullscreen) {
                wrapper.webkitRequestFullscreen();
            } else if (wrapper.msRequestFullscreen) {
                wrapper.msRequestFullscreen();
            }
        }

        function exitFullscreen() {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) {
                document.msExitFullscreen();
            }
        }

        // Double-click video to toggle fullscreen
        video.addEventListener('dblclick', toggleFullscreen);

        // Carousel functionality
        const channelCarousel = document.getElementById('channelCarousel');
        const carouselTrack = document.getElementById('carouselTrack');
        const hoverZone = document.getElementById('hoverZone');
        const videoWrapper = document.getElementById('videoWrapper');
        let carouselTimeout;

        function showCarousel() {
            clearTimeout(carouselTimeout);
            channelCarousel.classList.add('visible');
        }

        function hideCarousel() {
            carouselTimeout = setTimeout(() => {
                channelCarousel.classList.remove('visible');
            }, 300);
        }

        // Show carousel when hovering top area of video
        hoverZone.addEventListener('mouseenter', showCarousel);
        channelCarousel.addEventListener('mouseenter', showCarousel);
        channelCarousel.addEventListener('mouseleave', hideCarousel);
        hoverZone.addEventListener('mouseleave', hideCarousel);

        // Scroll carousel with arrows
        function scrollCarousel(direction) {
            const scrollAmount = 200;
            carouselTrack.scrollBy({
                left: direction * scrollAmount,
                behavior: 'smooth'
            });
        }

        // Render carousel channels
        function renderCarousel() {
            if (channels.length === 0) {
                carouselTrack.innerHTML = '<div class="text-center text-gray-500 text-sm w-full py-4">Load a playlist to see channels</div>';
                return;
            }

            carouselTrack.innerHTML = channels.map((channel, index) => `
                <div 
                    onclick="playChannel(${index})"
                    class="carousel-item flex-shrink-0 w-28 cursor-pointer rounded-xl bg-white/10 border-2 border-transparent backdrop-blur-sm overflow-hidden ${currentChannel === index ? 'active' : ''}"
                >
                    <div class="w-28 h-16 bg-indigo-600/20 flex items-center justify-center overflow-hidden">
                        ${channel.logo 
                            ? `<img src="${channel.logo}" alt="" class="w-full h-full object-cover" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'"><span class="hidden text-2xl">ðŸ“º</span>`
                            : '<span class="text-2xl">ðŸ“º</span>'
                        }
                    </div>
                    <div class="p-2">
                        <p class="text-xs font-medium truncate text-center">${channel.name}</p>
                    </div>
                </div>
            `).join('');

            // Scroll to current channel
            if (currentChannel !== null) {
                scrollToCurrentChannel();
            }
        }

        function scrollToCurrentChannel() {
            const items = carouselTrack.querySelectorAll('.carousel-item');
            if (items[currentChannel]) {
                const item = items[currentChannel];
                const trackRect = carouselTrack.getBoundingClientRect();
                const itemRect = item.getBoundingClientRect();
                const scrollLeft = item.offsetLeft - (trackRect.width / 2) + (itemRect.width / 2);
                carouselTrack.scrollTo({ left: scrollLeft, behavior: 'smooth' });
            }
        }
    </script>
</body>
</html>
